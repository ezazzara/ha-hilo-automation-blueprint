blueprint:
  name: Hilo Challenge Control â€“ AM/PM Temperature Strategy
  description: >
    Manage Hilo challenge phases dynamically with separate AM and PM temperature strategies,
    skip toggles, preheat, comfort recovery, and scene restoration.

    Phases:
      1ï¸âƒ£ Preheat â†’ triggered by Preheat sensor (unless skipped)
      2ï¸âƒ£ Challenge â†’ triggered by Peak in Progress (unless skipped)
      3ï¸âƒ£ Comfort Recovery â†’ automatically calculated from normal temperature + offset
      4ï¸âƒ£ Restore Scene â†’ restores user-defined scene after recovery
      Note: By default both AM and PM challenges are enabled.
  domain: automation

  input:
    # ===========================
    # 2ï¸âƒ£ Hilo Event Sensors ğŸ“¡
    # ===========================
    event_sensors:
      name: Hilo Event Sensors ğŸ“¡
      description: These sensors are controlled by the Hilo integration
      input:
        preheat_entity:
          name: Preheat Sensor
          description: Binary sensor that is ON during preheating
          selector:
            entity:
              domain: binary_sensor

        peak_entity:
          name: Peak in Progress Sensor
          description: Binary sensor ON during Hilo challenge/reduction
          selector:
            entity:
              domain: binary_sensor

    # ===========================
    # 1ï¸âƒ£ Participation & Skip Toggles ğŸŒ™â˜€ï¸
    # ===========================
    skip_toggles:
      name: Participation & Skip Toggles ğŸŒ™â˜€ï¸
      description: Control which Hilo events to participate in
      input:
        skip_am:
          name: Skip Next AM Challenge â˜€ï¸
          description: Skip all preheat, challenge, and recovery for the next AM event
          default: false
          selector:
            boolean:

        skip_pm:
          name: Skip Next PM Challenge ğŸŒ™
          description: Skip all preheat, challenge, and recovery for the next PM event
          default: false
          selector:
            boolean:

        do_pre_heat:
          name: Enable Preheat ğŸ”¥
          description: Turn on preheating before the challenge
          default: true
          selector:
            boolean:

    # ===========================
    # 3ï¸âƒ£ Devices to Control âš¡
    # ===========================
    devices:
      name: Devices to Control âš¡
      description: Thermostats and optional water heater switches to manage during Hilo phases
      input:
        thermostats:
          name: Thermostats ğŸŒ¡ï¸
          description: Thermostats to adjust during Hilo phases
          selector:
            entity:
              domain: climate
              multiple: true

        water_heater:
          name: Water Heater ğŸ’§ (Optional)
          description: Switch to turn off during challenge/reduction phases
          default: []
          selector:
            entity:
              domain: switch
              multiple: true

    # ===========================
    # 4ï¸âƒ£ Temperature Strategy ğŸŒ¡ï¸
    # ===========================
    temperature_strategy:
      name: Temperature Strategy ğŸŒ¡ï¸
      description: Define temperatures for normal, preheat, challenge, and recovery phases
      input:
        normal_temp:
          name: Normal Temperature
          description: Base temperature when no challenge is active
          default: 21
          selector:
            number:
              min: 15
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"

        preheat_temp_am:
          name: AM Preheat Temperature â˜€ï¸
          description: Temperature to use during AM preheat
          default: 23
          selector:
            number:
              min: 15
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"

        preheat_temp_pm:
          name: PM Preheat Temperature ğŸŒ™
          description: Temperature to use during PM preheat
          default: 23
          selector:
            number:
              min: 15
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"

        challenge_temp_am:
          name: AM Challenge Temperature â˜€ï¸
          description: Temperature during AM peak/reduction
          default: 17
          selector:
            number:
              min: 15
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"

        challenge_temp_pm:
          name: PM Challenge Temperature ğŸŒ™
          description: Temperature during PM peak/reduction
          default: 17
          selector:
            number:
              min: 15
              max: 25
              step: 0.5
              unit_of_measurement: "Â°C"

        appreciation_offset_am:
          name: AM Comfort Recovery Offset â˜€ï¸
          description: Added to normal temperature after AM peak
          default: 2
          selector:
            number:
              min: 0
              max: 5
              step: 0.5
              unit_of_measurement: "Â°C"

        appreciation_offset_pm:
          name: PM Comfort Recovery Offset ğŸŒ™
          description: Added to normal temperature after PM peak
          default: 2
          selector:
            number:
              min: 0
              max: 5
              step: 0.5
              unit_of_measurement: "Â°C"

        comfort_recovery_duration:
          name: Comfort Recovery Duration â±ï¸
          description: How long to hold comfort recovery temperature before restoring scene
          default: "00:30:00"
          selector:
            duration:

    # ===========================
    # 5ï¸âƒ£ Post-Challenge Settings ğŸ¬
    # ===========================
    post_challenge_settings:
      name: Post-Challenge Settings ğŸ¬
      description: Actions to perform after a challenge event is completed
      input:
        restore_scene:
          name: Scene to Restore
          description: Scene to activate after all Hilo phases and comfort recovery
          selector:
            entity:
              domain: scene

# ===========================
# TRIGGERS
# ===========================
triggers:
  - platform: state
    entity_id:
      - !input preheat_entity
  - platform: state
    entity_id:
      - !input peak_entity

# ===========================
# VARIABLES
# ===========================
variables:
  # Devices
  thermostats: !input thermostats
  water_heater: !input water_heater
  preheat_entity: !input preheat_entity
  peak_entity: !input peak_entity
  restore_scene: !input restore_scene

  # Toggles
  skip_am: !input skip_am
  skip_pm: !input skip_pm
  do_pre_heat: !input do_pre_heat

  # Temperatures & offsets
  normal_temp: !input normal_temp
  preheat_temp_am: !input preheat_temp_am
  preheat_temp_pm: !input preheat_temp_pm
  challenge_temp_am: !input challenge_temp_am
  challenge_temp_pm: !input challenge_temp_pm
  appreciation_offset_am: !input appreciation_offset_am
  appreciation_offset_pm: !input appreciation_offset_pm
  comfort_recovery_duration: !input comfort_recovery_duration

  # Time context
  current_hour: "{{ now().hour }}"
  is_am: "{{ 0 <= current_hour < 12 }}"
  is_pm: "{{ 12 <= current_hour < 24 }}"

  # -----------------------------
  # Effective temperatures
  # -----------------------------
  effective_preheat_temp: >
    {% if do_pre_heat and is_state(preheat_entity, 'on') %}
      {% if is_am and not skip_am %}
        {{ preheat_temp_am | float }}
      {% elif is_pm and not skip_pm %}
        {{ preheat_temp_pm | float }}
      {% else %}
        {{ none }}
      {% endif %}
    {% else %}
      {{ none }}
    {% endif %}

  effective_challenge_temp: >
    {% if is_state(peak_entity, 'on') %}
      {% if is_am and not skip_am %}
        {{ challenge_temp_am | float }}
      {% elif is_pm and not skip_pm %}
        {{ challenge_temp_pm | float }}
      {% else %}
        {{ none }}
      {% endif %}
    {% else %}
      {{ none }}
    {% endif %}

  # Effective Recovery Temp
    # Recovery should only run after a challenge has completed.
    # We assume a challenge has run if:
    #   1. The peak sensor (`peak_entity`) WAS on, and
    #   2. The skip toggle for the relevant AM/PM period is not active.
    # TODO: Improvement: set variable when challenge starts and check that instead of relying on peak_entity state
  effective_recovery_temp: >
    {% if not is_state(peak_entity, 'on') and ((is_am and not skip_am) or (is_pm and not skip_pm)) %}
      {% if is_am %}
        {{ (normal_temp | float) + (appreciation_offset_am | float) }}
      {% else %}
        {{ (normal_temp | float) + (appreciation_offset_pm | float) }}
      {% endif %}
    {% else %}
      {{ none }}
    {% endif %}

# ===========================
# ACTIONS
# ===========================
action:
  # 1ï¸âƒ£ Preheat
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effective_preheat_temp is not none }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostats
            data:
              temperature: "{{ effective_preheat_temp }}"
          - choose:
              - conditions: "{{ water_heater | length > 0 }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input water_heater

  # 2ï¸âƒ£ Challenge
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effective_challenge_temp is not none }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostats
            data:
              temperature: "{{ effective_challenge_temp }}"
          - choose:
              - conditions: "{{ water_heater | length > 0 }}"
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: !input water_heater

  # 3ï¸âƒ£ Recovery / Restore
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ effective_recovery_temp is not none }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostats
            data:
              temperature: "{{ effective_recovery_temp }}"
          - choose:
              - conditions: "{{ water_heater | length > 0 }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input water_heater
          - delay: !input comfort_recovery_duration
          - service: scene.turn_on
            target:
              entity_id: !input restore_scene
          - service: homeassistant.turn_off
            data:
              entity_id:
                - "{{ skip_am if is_am else skip_pm }}"

