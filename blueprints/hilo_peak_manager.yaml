blueprint:
  name: Hilo Challenge Control â€“ AM/PM Strategy
  description: >
    Controls heating for Hilo challenges (preheat, reduction, comfort recovery)
    with separate AM/PM temps, skip toggles, optional switches, and a restore scene.
  domain: automation

  input:
    # âš™ï¸ General Settings
    challenge_am:
      name: "Participate in AM Challenge"
      default: true
      selector:
        boolean:
      section:
        name: "âš™ï¸ General Settings"
        description: "Enable or skip challenges, and enable preheat"
        collapsed: true

    challenge_pm:
      name: "Participate in PM Challenge"
      default: true
      selector:
        boolean:
      section:
        name: "âš™ï¸ General Settings"

    skip_am:
      name: "Skip Next AM Challenge"
      default: false
      selector:
        boolean:
      section:
        name: "âš™ï¸ General Settings"

    skip_pm:
      name: "Skip Next PM Challenge"
      default: false
      selector:
        boolean:
      section:
        name: "âš™ï¸ General Settings"

    do_pre_heat:
      name: "Enable Preheat"
      default: true
      selector:
        boolean:
      section:
        name: "âš™ï¸ General Settings"

    # ðŸ”— Hilo Sensors
    preheat_entity:
      name: "Preheat Sensor"
      selector:
        entity:
          domain: binary_sensor
      section:
        name: "ðŸ”— Hilo Sensors"
        description: "Sensors that indicate preheat or peak in progress"
        collapsed: true

    peak_entity:
      name: "Peak in Progress Sensor"
      selector:
        entity:
          domain: binary_sensor
      section:
        name: "ðŸ”— Hilo Sensors"

    # ðŸ”¥ Devices & Switches
    thermostats:
      name: "Thermostats"
      selector:
        entity:
          domain: climate
          multiple: true
      section:
        name: "ðŸ”¥ Devices & Switches"
        description: "Thermostats and optional switches to control during events"
        collapsed: true

    water_heater:
      name: "Water Heater (optional)"
      default: []
      selector:
        entity:
          domain: switch
          multiple: true
      section:
        name: "ðŸ”¥ Devices & Switches"

    other_switches:
      name: "Other Switches (optional)"
      default: []
      selector:
        entity:
          domain: switch
          multiple: true
      section:
        name: "ðŸ”¥ Devices & Switches"

    # ðŸŒ¡ï¸ Temperature Strategy
    normal_temp:
      name: "Normal Temperature (Â°C)"
      default: 21
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
      section:
        name: "ðŸŒ¡ï¸ Temperature Strategy"
        description: "Define temps for normal, challenge (AM/PM), preheat, recovery"
        collapsed: true

    preheat_temp:
      name: "Preheat Temperature (Â°C)"
      default: 23
      selector:
        number:
          min: 10
          max: 30
          step: 0.5
      section:
        name: "ðŸŒ¡ï¸ Temperature Strategy"

    challenge_temp_am:
      name: "AM Challenge Temperature (Â°C)"
      default: 17
      selector:
        number:
          min: 10
          max: 25
          step: 0.5
      section:
        name: "ðŸŒ¡ï¸ Temperature Strategy"

    challenge_temp_pm:
      name: "PM Challenge Temperature (Â°C)"
      default: 17
      selector:
        number:
          min: 10
          max: 25
          step: 0.5
      section:
        name: "ðŸŒ¡ï¸ Temperature Strategy"

    appreciation_offset:
      name: "Comfort Recovery Offset (Â°C)"
      default: 2
      selector:
        number:
          min: 0
          max: 5
          step: 0.5
      section:
        name: "ðŸŒ¡ï¸ Temperature Strategy"

    recovery_duration:
      name: "Comfort Recovery Duration"
      default: "00:30:00"
      selector:
        duration:
      section:
        name: "ðŸŒ¡ï¸ Temperature Strategy"

    # ðŸŽ¬ Scene Restoration
    restore_scene:
      name: "Scene to Restore"
      selector:
        entity:
          domain: scene
      section:
        name: "ðŸŽ¬ Scene Restoration"
        description: "Scene to restore after comfort recovery"
        collapsed: true

# ===========================
# TRIGGERS
# ===========================
triggers:
  - platform: state
    entity_id: !input preheat_entity
  - platform: state
    entity_id: !input peak_entity

# ===========================
# VARIABLES
# ===========================
variables:
  # Inputs
  challenge_am: !input challenge_am
  challenge_pm: !input challenge_pm
  skip_am: !input skip_am
  skip_pm: !input skip_pm
  do_pre_heat: !input do_pre_heat
  thermostats: !input thermostats
  water_heater: !input water_heater
  other_switches: !input other_switches
  preheat_entity: !input preheat_entity
  peak_entity: !input peak_entity
  normal_temp: !input normal_temp
  preheat_temp: !input preheat_temp
  challenge_temp_am: !input challenge_temp_am
  challenge_temp_pm: !input challenge_temp_pm
  appreciation_offset: !input appreciation_offset
  recovery_duration: !input recovery_duration
  restore_scene: !input restore_scene

  # Derived
  appreciation_temp_am: "{{ normal_temp + appreciation_offset }}"
  appreciation_temp_pm: "{{ normal_temp + appreciation_offset }}"

  effective_challenge_temp: >
    {% if challenge_am and not skip_am %}
      {{ challenge_temp_am }}
    {% elif challenge_pm and not skip_pm %}
      {{ challenge_temp_pm }}
    {% else %}
      {{ normal_temp }}
    {% endif %}

# ===========================
# ACTIONS
# ===========================
action:
  - choose:
      # 1ï¸âƒ£ Challenge / Reduction Phase
      - conditions:
          - condition: state
            entity_id: !input peak_entity
            state: "on"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostats
            data:
              temperature: "{{ effective_challenge_temp }}"
          - choose:
              - conditions: "{{ water_heater | length > 0 }}"
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: !input water_heater
          - choose:
              - conditions: "{{ other_switches | length > 0 }}"
                sequence:
                  - service: switch.turn_off
                    target:
                      entity_id: !input other_switches

      # 2ï¸âƒ£ Preheat Phase
      - conditions:
          - condition: state
            entity_id: !input preheat_entity
            state: "on"
          - condition: template
            value_template: >
              {% if challenge_am %} {{ not skip_am }} {% elif challenge_pm %} {{ not skip_pm }} {% else %} false {% endif %}
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostats
            data:
              temperature: !input preheat_temp
          - choose:
              - conditions: "{{ water_heater | length > 0 }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input water_heater
          - choose:
              - conditions: "{{ other_switches | length > 0 }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input other_switches

    default:
      # 3ï¸âƒ£ Comfort Recovery / Restore Scene
      - choose:
          - conditions:
              - condition: state
                entity_id: !input peak_entity
                state: "off"
          - condition: template
            value_template: >
              {% if challenge_am %} {{ not skip_am }} {% elif challenge_pm %} {{ not skip_pm }} {% else %} true {% endif %}
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input thermostats
            data:
              temperature: >
                {% if challenge_am %} {{ appreciation_temp_am }} {% else %} {{ appreciation_temp_pm }} {% endif %}
          - choose:
              - conditions: "{{ water_heater | length > 0 }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input water_heater
          - choose:
              - conditions: "{{ other_switches | length > 0 }}"
                sequence:
                  - service: switch.turn_on
                    target:
                      entity_id: !input other_switches
          - delay: !input recovery_duration
          - service: scene.turn_on
            target:
              entity_id: !input restore_scene
